# =============================================================================
# Routing Policy for Tri-Agent Router v2.0.0
# =============================================================================
# Multi-signal classification rules for intelligent task routing
#
# Rule Evaluation Order:
# 1. Forced routing (--claude, --gemini, --codex) bypasses all rules
# 2. Rules are evaluated in order, first match wins
# 3. Multiple conditions within a rule use AND logic
# 4. Confidence scores are combined when multiple signals match
# 5. If combined confidence < threshold, user confirmation is requested
#
# Supported condition types:
# - keyword: Pattern matching in prompt text (regex)
# - file_size: Total size of provided files in bytes
# - file_count: Number of files provided
# - token_estimate: Estimated token count (bytes / 4 heuristic)
# - file_extension: Match specific file extensions
# - complexity: Heuristic complexity score (keyword density)
# =============================================================================

version: "2.0.0"
metadata:
  description: "Tri-agent routing policy for Claude/Gemini/Codex selection"
  author: "tri-agent-system"
  updated: "2025-12-27"

# Global settings
settings:
  default_model: "claude"
  confidence_threshold: 0.7          # Below this, prompt user for confirmation
  file_size_threshold: 51200         # 50KB - triggers large context handling
  token_threshold: 100000            # 100K tokens - triggers Gemini routing
  file_count_threshold: 10           # >10 files - triggers Gemini routing
  enable_user_confirmation: true     # Prompt when confidence is low
  enable_logging: true               # Log routing decisions

# =============================================================================
# Primary Routing Rules
# =============================================================================
# Rules are evaluated in order. First matching rule is applied.
# Each rule has:
#   - name: Unique identifier for logging
#   - model: Target model (claude, gemini, codex)
#   - confidence: Base confidence score for this rule
#   - conditions: Array of conditions (all must match - AND logic)
#   - boost: Optional confidence boost when multiple signals match
# =============================================================================

routing_rules:
  # ---------------------------------------------------------------------------
  # GEMINI Rules - Large Context & Analysis
  # ---------------------------------------------------------------------------
  - name: "large_context_file_size"
    description: "Route large files to Gemini (1M context)"
    model: "gemini"
    confidence: 0.95
    conditions:
      - type: "file_size"
        operator: "gt"
        value: 51200                  # >50KB
    reason: "File size exceeds 50KB threshold - Gemini has 1M token context"

  - name: "large_context_token_estimate"
    description: "Route high token count to Gemini"
    model: "gemini"
    confidence: 0.95
    conditions:
      - type: "token_estimate"
        operator: "gt"
        value: 100000                 # >100K tokens
    reason: "Estimated tokens exceed 100K - requires Gemini's extended context"

  - name: "multi_file_analysis"
    description: "Route multi-file analysis to Gemini"
    model: "gemini"
    confidence: 0.90
    conditions:
      - type: "file_count"
        operator: "gt"
        value: 10                     # >10 files
    reason: "Multiple files require Gemini's large context window"

  - name: "codebase_analysis"
    description: "Full codebase analysis patterns"
    model: "gemini"
    confidence: 0.90
    conditions:
      - type: "keyword"
        operator: "match"
        pattern: "(entire|full|whole|complete)\\s+(codebase|project|repository|repo)"
        case_insensitive: true
    reason: "Full codebase analysis requires Gemini's 1M context"

  - name: "multimodal_content"
    description: "Route multimodal tasks to Gemini"
    model: "gemini"
    confidence: 0.92
    conditions:
      - type: "keyword"
        operator: "match"
        pattern: "(image|video|pdf|screenshot|diagram|picture|photo|multimodal)"
        case_insensitive: true
    reason: "Multimodal content benefits from Gemini's capabilities"

  - name: "documentation_analysis"
    description: "Large documentation analysis"
    model: "gemini"
    confidence: 0.85
    conditions:
      - type: "keyword"
        operator: "match"
        pattern: "(document|summarize|analyze)\\s+(all|entire|full|everything)"
        case_insensitive: true
    reason: "Documentation analysis with large context"

  # ---------------------------------------------------------------------------
  # CODEX Rules - Implementation & Rapid Development
  # ---------------------------------------------------------------------------
  - name: "implementation_keywords"
    description: "Route implementation tasks to Codex"
    model: "codex"
    confidence: 0.85
    conditions:
      - type: "keyword"
        operator: "match"
        pattern: "\\b(implement|build|create|generate|write|scaffold|prototype)\\b"
        case_insensitive: true
    reason: "Implementation task - Codex excels at rapid code generation"

  - name: "bug_fix"
    description: "Route bug fixes to Codex"
    model: "codex"
    confidence: 0.80
    conditions:
      - type: "keyword"
        operator: "match"
        pattern: "\\b(fix|debug|repair|patch|hotfix|bugfix)\\b"
        case_insensitive: true
    reason: "Bug fix task - Codex with xhigh reasoning for debugging"

  - name: "test_generation"
    description: "Route test generation to Codex"
    model: "codex"
    confidence: 0.80
    conditions:
      - type: "keyword"
        operator: "match"
        pattern: "\\b(test|spec|unittest|e2e|integration test)\\s*(generate|write|create)"
        case_insensitive: true
    reason: "Test generation - Codex for rapid test scaffolding"

  - name: "refactoring"
    description: "Route refactoring to Codex"
    model: "codex"
    confidence: 0.78
    conditions:
      - type: "keyword"
        operator: "match"
        pattern: "\\b(refactor|restructure|reorganize|optimize code)\\b"
        case_insensitive: true
    reason: "Refactoring task - Codex for code transformation"

  - name: "api_implementation"
    description: "Route API implementation to Codex"
    model: "codex"
    confidence: 0.82
    conditions:
      - type: "keyword"
        operator: "match"
        pattern: "\\b(api|endpoint|route|controller|handler)\\s*(implement|create|add)"
        case_insensitive: true
    reason: "API implementation - Codex for rapid development"

  # ---------------------------------------------------------------------------
  # CLAUDE Rules - Architecture, Design & Complex Reasoning
  # ---------------------------------------------------------------------------
  - name: "architecture_design"
    description: "Route architecture decisions to Claude"
    model: "claude"
    confidence: 0.90
    conditions:
      - type: "keyword"
        operator: "match"
        pattern: "\\b(architect|design|pattern|structure|system design|scalability)\\b"
        case_insensitive: true
    reason: "Architecture decisions require Claude's deep reasoning"

  - name: "security_analysis"
    description: "Route security tasks to Claude"
    model: "claude"
    confidence: 0.92
    conditions:
      - type: "keyword"
        operator: "match"
        pattern: "\\b(security|vulnerability|owasp|penetration|audit|authentication|authorization)\\b"
        case_insensitive: true
    reason: "Security analysis requires Claude's thorough reasoning"

  - name: "complex_reasoning"
    description: "Route complex reasoning to Claude"
    model: "claude"
    confidence: 0.88
    conditions:
      - type: "keyword"
        operator: "match"
        pattern: "\\b(analyze|evaluate|compare|tradeoff|decision|complex|think|reason)\\b"
        case_insensitive: true
    reason: "Complex reasoning task - Claude for deep analysis"

  - name: "planning_strategy"
    description: "Route planning tasks to Claude"
    model: "claude"
    confidence: 0.85
    conditions:
      - type: "keyword"
        operator: "match"
        pattern: "\\b(plan|strategy|approach|roadmap|breakdown|prioritize)\\b"
        case_insensitive: true
    reason: "Planning task - Claude for strategic thinking"

  - name: "code_review"
    description: "Route code review to Claude"
    model: "claude"
    confidence: 0.82
    conditions:
      - type: "keyword"
        operator: "match"
        pattern: "\\b(review|critique|feedback|improve|best practices)\\b"
        case_insensitive: true
    reason: "Code review - Claude for balanced analysis"

  - name: "ultrathink_trigger"
    description: "Explicit ultra-deep thinking request"
    model: "claude"
    confidence: 0.98
    conditions:
      - type: "keyword"
        operator: "match"
        pattern: "\\b(ultrathink|deep think|think hard|extended reasoning)\\b"
        case_insensitive: true
    reason: "Explicit request for Claude's extended thinking mode"

# =============================================================================
# Confidence Modifiers
# =============================================================================
# Applied after primary rule matching to adjust confidence
# =============================================================================

confidence_modifiers:
  # Boost confidence for explicit model mentions
  - name: "explicit_claude_mention"
    pattern: "\\b(claude|opus|anthropic)\\b"
    target_model: "claude"
    modifier: 0.10
    type: "boost"

  - name: "explicit_gemini_mention"
    pattern: "\\b(gemini|google ai|bard)\\b"
    target_model: "gemini"
    modifier: 0.10
    type: "boost"

  - name: "explicit_codex_mention"
    pattern: "\\b(codex|gpt-5|openai|chatgpt)\\b"
    target_model: "codex"
    modifier: 0.10
    type: "boost"

  # Reduce confidence for ambiguous prompts
  - name: "short_prompt_penalty"
    condition:
      type: "prompt_length"
      operator: "lt"
      value: 50
    modifier: -0.15
    type: "penalty"
    reason: "Short prompts are harder to classify accurately"

  # Boost for multiple matching signals
  - name: "multi_signal_boost"
    condition:
      type: "signal_count"
      operator: "gt"
      value: 2
    modifier: 0.08
    type: "boost"
    reason: "Multiple routing signals increase confidence"

# =============================================================================
# File Extension Routing Hints
# =============================================================================
# Provides hints based on file types being processed
# =============================================================================

file_extension_hints:
  # Large/binary files strongly suggest Gemini
  gemini_preferred:
    extensions: [".pdf", ".png", ".jpg", ".jpeg", ".gif", ".webp", ".mp4", ".webm"]
    confidence_boost: 0.15
    reason: "Multimodal content"

  # Code files are neutral but can provide context
  code_files:
    extensions: [".ts", ".tsx", ".js", ".jsx", ".py", ".go", ".rs", ".java", ".cpp"]
    confidence_boost: 0.0
    reason: "Standard code files - route based on task type"

  # Config/infra files may need specialized handling
  infrastructure_files:
    extensions: [".yaml", ".yml", ".toml", ".tf", ".dockerfile", ".k8s"]
    model_hint: "codex"
    confidence_boost: 0.05
    reason: "Infrastructure files - implementation focused"

# =============================================================================
# Fallback Configuration
# =============================================================================

fallback:
  # If no rules match with sufficient confidence
  default_model: "claude"
  default_confidence: 0.60
  reason: "Claude is the default orchestrator for unclassified tasks"

  # Fallback order when primary model fails
  fallback_chain:
    - model: "claude"
      reason: "Primary orchestrator"
    - model: "codex"
      reason: "Implementation fallback"
    - model: "gemini"
      reason: "Large context fallback"

# =============================================================================
# Consensus Rules
# =============================================================================
# When to require multi-model consensus
# =============================================================================

consensus_triggers:
  - name: "critical_decision"
    pattern: "\\b(critical|important|major|breaking change|production)\\b"
    require_consensus: true
    min_approvals: 2

  - name: "security_change"
    pattern: "\\b(authentication|authorization|password|secret|token|key)\\s+(change|update|modify)"
    require_consensus: true
    min_approvals: 3

  - name: "architecture_change"
    pattern: "\\b(architecture|database|schema|migration)\\s+(change|update|refactor)"
    require_consensus: true
    min_approvals: 2

# =============================================================================
# Logging Configuration
# =============================================================================

logging:
  log_file: "logs/routing-decisions.jsonl"
  log_level: "INFO"
  include_prompt_hash: true
  include_file_hashes: false
  mask_secrets: true
  retention_days: 30
