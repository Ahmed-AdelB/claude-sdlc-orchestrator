# =============================================================================
# Tri-Agent System Configuration v2.0.0
# =============================================================================
# Single source of truth for all tri-agent orchestration settings
#
# Subscription Context:
# - Claude Max: $200/month (Double limits until Dec 31, 2025!)
#   - 900 msgs/5hr Opus, Sonnet unlimited
# - ChatGPT Pro: $200/month (Codex GPT-5.2 with xhigh reasoning)
#   - Unlimited access, reasoning summaries
# - Google AI Ultra: $20/month (Gemini 3 Pro Preview, 1M context)
#   - High thinking level
#
# Note: Subscription-based = unlimited usage, track metrics only
# =============================================================================

system:
  version: "2.0.0"
  default_mode: "tri-agent"  # autonomous | tri-agent | consensus
  trace_id_prefix: "tri"
  project_dir: ""  # Set at runtime

# =============================================================================
# Model Configuration
# =============================================================================
models:
  claude:
    enabled: true
    role: "orchestrator"
    model: "opus"
    fallback_model: "sonnet"
    max_budget_usd: 50
    cli_command: "claude"
    context_window: 200000
    max_thinking_tokens: 32000
    timeout_seconds: 300
    failover_to: "codex"
    flags:
      - "--dangerously-skip-permissions"
      - "--model"
      - "opus"
      - "--max-budget-usd"
      - "50"
      - "--fallback-model"
      - "sonnet"

  gemini:
    enabled: true
    role: "analyst"
    model: "gemini-3-pro-preview"
    cli_command: "gemini"
    context_window: 1000000
    thinking_level: "high"
    auth_type: "oauth-personal"
    timeout_seconds: 300
    flags:
      - "-m"
      - "gemini-3-pro-preview"
      - "--approval-mode"
      - "yolo"

  codex:
    enabled: true
    role: "implementer"
    model: "gpt-5.2-codex"
    cli_command: "codex"
    context_window: 400000
    reasoning_effort: "xhigh"
    sandbox_mode: "workspace-write"  # workspace-write | danger-full-access
    timeout_seconds: 240
    skip_git_check: true
    flags:
      - "exec"
      - "-m"
      - "gpt-5.2-codex"
      - "-c"
      - "model_reasoning_effort=\"xhigh\""
      - "-s"
      - "workspace-write"
      - "--skip-git-repo-check"

# =============================================================================
# Routing Configuration
# =============================================================================
routing:
  auto_detect: true
  file_size_threshold: 51200      # 50KB - route to Gemini
  context_threshold: 100000       # 100K tokens - route to Gemini
  confidence_threshold: 0.7       # Below this, prompt user
  policy_file: "config/routing-policy.yaml"

  # Keyword-based routing weights
  keywords:
    gemini:
      patterns:
        - "entire codebase"
        - "all files"
        - "full project"
        - "analyze everything"
      weight: 0.9

    codex:
      patterns:
        - "implement"
        - "build"
        - "fix"
        - "create"
        - "write"
        - "prototype"
      weight: 0.8

    claude:
      patterns:
        - "design"
        - "architect"
        - "security"
        - "review"
        - "plan"
        - "think"
      weight: 0.85

# =============================================================================
# Error Handling
# =============================================================================
error_handling:
  max_retries: 3
  backoff_base: 5               # seconds
  backoff_max: 300              # 5 min max
  backoff_multiplier: 2
  jitter: true                  # Add randomness to prevent thundering herd
  fallback_order:
    - "claude"
    - "codex"
    - "gemini"
  retry_budget_per_task: 5      # Total retries across all fallbacks

  # Error type classification patterns
  error_patterns:
    rate_limit:
      - "rate limit"
      - "429"
      - "quota exceeded"
      - "too many requests"
    auth_error:
      - "authentication"
      - "unauthorized"
      - "401"
      - "403"
      - "invalid token"
    timeout:
      - "timeout"
      - "timed out"
      - "deadline exceeded"
    model_unavailable:
      - "model not found"
      - "404"
      - "model unavailable"
    # Codex-specific error patterns (#109)
    codex_reasoning:
      - "reasoning_budget_exceeded"
      - "reasoning budget"
      - "reasoning timeout"
      - "model_reasoning_timeout"
    codex_context:
      - "context_compaction_failed"
      - "context compaction"
      - "context_too_large"
    codex_output:
      - "output_token_limit"
      - "max output tokens"
    codex_sandbox:
      - "sandbox_permission_denied"
      - "sandbox permission"

# =============================================================================
# Circuit Breaker
# =============================================================================
circuit_breaker:
  failure_threshold: 3          # Consecutive failures to open
  cooldown_seconds: 60          # Time before half-open
  half_open_max_calls: 1        # Test calls in half-open state

# =============================================================================
# Cost Limits (Optional Guardrail)
# =============================================================================
# Disabled by default; enable and configure to enforce daily spend limits.
cost_limits:
  enabled: false
  daily_budget_usd: 0           # Set >0 to enable breaker
  margin_pct: 0.15              # Stop new calls before budget (15% margin)
  reserve_usd: 1.0              # Buffer per request for variance
  per_1k_tokens:
    claude:
      input: 0
      output: 0
    gemini:
      input: 0
      output: 0
    codex:
      input: 0
      output: 0

# =============================================================================
# Logging Configuration
# =============================================================================
logging:
  format: "jsonl"
  level: "INFO"                 # DEBUG, INFO, WARN, ERROR
  rotation: "daily"
  retention_days: 7
  audit_mode: false             # Record prompt/response hashes

  # Log directories (relative to autonomous root)
  directories:
    sessions: "logs/sessions"
    errors: "logs/errors"
    costs: "logs/costs"
    audit: "logs/audit"

# =============================================================================
# Monitoring Configuration
# =============================================================================
monitoring:
  health_check_interval: 300    # 5 minutes
  desktop_notifications: true
  status_file: "state/health.json"
  metrics_retention_days: 30

  # Health check thresholds
  thresholds:
    error_rate_warning: 0.1     # 10% error rate
    error_rate_critical: 0.25   # 25% error rate
    response_time_warning: 30   # seconds
    response_time_critical: 120 # seconds

# =============================================================================
# Consensus Mode
# =============================================================================
consensus:
  enabled: true
  voting_mode: "majority"       # majority | weighted | veto
  min_approvals: 2              # Minimum approvals needed
  timeout_per_model: 60         # seconds
  partial_failure_policy: "continue"  # continue | abort

  # Weighted voting (if voting_mode: weighted)
  weights:
    claude: 0.4
    gemini: 0.3
    codex: 0.3

  # Veto rules (if voting_mode: veto)
  veto:
    enabled_for:
      - "security"
      - "architecture"
    veto_holder: "claude"

# =============================================================================
# Session Management
# =============================================================================
sessions:
  checkpoint_interval: 300      # 5 minutes
  max_session_age: 86400        # 24 hours
  auto_resume: true
  tmux:
    socket_name: "tri-agent"
    session_prefix: "tri-agent"
    # Session naming: tri-agent-$USER-$PROJECT

# =============================================================================
# Security
# =============================================================================
security:
  mask_secrets: true
  mask_patterns:
    # OpenAI / Anthropic
    - 'sk-[a-zA-Z0-9]{20,}'
    - 'sk-proj-[a-zA-Z0-9]{20,}'
    - 'ANTHROPIC_API_KEY=[^\s]+'
    - 'OPENAI_API_KEY=[^\s]+'

    # Google
    - 'GOOGLE_API_KEY=[^\s]+'
    - 'AIza[a-zA-Z0-9_-]{35}'
    - 'GCLOUD_[A-Z_]+=[^\s]+'

    # AWS (SEC-010)
    - '(A3T|AKIA|ASIA|AGPA|AIDA|ANPA|ANVA|AROA|AIPA|APKA)[A-Z0-9]{16}'
    - 'AWS_ACCESS_KEY_ID=[A-Z0-9]{20}'
    - 'aws_access_key_id["\s:=]+[A-Za-z0-9/+=]{20,}'
    - 'aws_secret_access_key["\s:=]+[A-Za-z0-9/+=]{40,}'
    - 'aws_session_token["\s:=]+[A-Za-z0-9/+=]{16,}'
    - 'AWS_SECRET_ACCESS_KEY=[^\s]+'
    - 'AWS_SESSION_TOKEN=[^\s]+'
    - 'AWS_SECURITY_TOKEN=[^\s]+'
    - 'AWS_[A-Z_]+=[^\s]+'

    # Azure
    - 'azure[_-]?storage[_-]?key["\s:=]+[A-Za-z0-9/+=]{88}'
    - 'AZURE_[A-Z_]+=[^\s]+'
    - 'DefaultEndpointsProtocol=https;AccountName=[^;]+;AccountKey=[^;]+'

    # GitHub
    - 'ghp_[a-zA-Z0-9]{36,}'
    - 'gho_[a-zA-Z0-9]{36,}'
    - 'ghs_[a-zA-Z0-9]{36,}'
    - 'ghr_[a-zA-Z0-9]{36,}'
    - 'ghu_[a-zA-Z0-9]{36,}'
    - 'ghv_[a-zA-Z0-9]{36,}'
    - 'github_pat_[a-zA-Z0-9_]{22,}'

    # GitLab (SEC-010)
    - 'glpat-[a-zA-Z0-9_-]{20,}'

    # API keys (SEC-010)
    - 'sk-[a-zA-Z0-9]{20,}'
    - 'sk_[a-zA-Z0-9]{20,}'
    - 'pk_(live|test)_[a-zA-Z0-9]{16,}'
    - 'rk_(live|test)_[a-zA-Z0-9]{16,}'
    - 'api[_-]?(key|token)["\s:=]+[a-zA-Z0-9._-]{20,}'
    - 'client[_-]?secret["\s:=]+[a-zA-Z0-9._-]{20,}'

    # Generic tokens (SEC-010)
    - 'Bearer [a-zA-Z0-9._-]{20,}'
    - 'token["\s:=]+[a-zA-Z0-9._-]{20,}'
    - 'api[_-]?key["\s:=]+[a-zA-Z0-9._-]{20,}'
    - 'secret["\s:=]+[a-zA-Z0-9._-]{20,}'
    - 'password["\s:=]+[^\s"]{8,}'

    # HTTP Headers (SEC-010)
    - '[Aa]uthorization:\s*[^\n]+'
    - '[Xx]-[Aa]pi-[Kk]ey:\s*[^\n]+'

    # JWT tokens (SEC-010)
    - 'eyJ[a-zA-Z0-9_-]{10,}\.[a-zA-Z0-9_-]{10,}\.[a-zA-Z0-9_-]{10,}'
    - 'eyJhbGci[a-zA-Z0-9_-]*\.[a-zA-Z0-9_-]+\.[a-zA-Z0-9_-]+'
    - 'jwt["\s:=]+eyJ[a-zA-Z0-9_-]{10,}\.[a-zA-Z0-9_-]{10,}\.[a-zA-Z0-9_-]{10,}'

    # OAuth tokens (SEC-010)
    - 'oauth[_-]?token["\s:=]+[a-zA-Z0-9._~-]{20,}'
    - 'oauth[_-]?secret["\s:=]+[a-zA-Z0-9._~-]{20,}'
    - 'access_token["\s:=]+[a-zA-Z0-9._~-]{20,}'
    - 'refresh_token["\s:=]+[a-zA-Z0-9._~-]{20,}'
    - 'id_token["\s:=]+[a-zA-Z0-9._~-]{20,}'
    - 'ya29\.[a-zA-Z0-9._-]{20,}'

    # Private keys
    - '-----BEGIN PRIVATE KEY-----'
    - '-----BEGIN ENCRYPTED PRIVATE KEY-----'
    - '-----BEGIN RSA PRIVATE KEY-----'
    - '-----BEGIN EC PRIVATE KEY-----'
    - '-----BEGIN DSA PRIVATE KEY-----'
    - '-----BEGIN OPENSSH PRIVATE KEY-----'
    - '-----BEGIN PGP PRIVATE KEY BLOCK-----'

    # Database connection strings
    - 'postgres(ql)?://[^\s:@/]+:[^\s@/]+@[^\s]+'
    - 'mysql://[^\s:@/]+:[^\s@/]+@[^\s]+'
    - 'mariadb://[^\s:@/]+:[^\s@/]+@[^\s]+'
    - 'mongodb(\+srv)?://[^\s:@/]+:[^\s@/]+@[^\s]+'
    - 'rediss?://[^\s:@/]+:[^\s@/]+@[^\s]+'
    - 'sqlserver://[^\s:@/]+:[^\s@/]+@[^\s]+'
    - 'mssql://[^\s:@/]+:[^\s@/]+@[^\s]+'
    - 'oracle://[^\s:@/]+:[^\s@/]+@[^\s]+'
    - 'cockroachdb://[^\s:@/]+:[^\s@/]+@[^\s]+'
    - 'jdbc:(postgresql|mysql|mariadb|sqlserver|oracle)://[^\s:@/]+:[^\s@/]+@[^\s]+'

    # Slack
    - 'xox[baprs]-[a-zA-Z0-9-]+'

    # Stripe
    - 'sk_live_[a-zA-Z0-9]{24,}'
    - 'rk_live_[a-zA-Z0-9]{24,}'

    # Twilio
    - 'SK[a-f0-9]{32}'

    # SendGrid
    - 'SG\.[a-zA-Z0-9_-]+\.[a-zA-Z0-9_-]+'

  # Files to never include in prompts
  excluded_files:
    - ".env"
    - ".env.*"
    - "credentials.json"
    - "*.pem"
    - "*.key"
    - "id_rsa*"

# =============================================================================
# Cost Tracking (Metrics Only - Subscription Based)
# =============================================================================
cost_tracking:
  enabled: true
  track_tokens: true
  track_requests: true
  daily_report: true
  report_time: "09:00"

  # Subscription info (for reference only)
  subscriptions:
    claude_max:
      cost_per_month: 200
      limits: "900 msgs/5hr Opus, unlimited Sonnet"
      promo: "Double limits until Dec 31, 2025"
    chatgpt_pro:
      cost_per_month: 200
      limits: "Unlimited Codex GPT-5.2 xhigh"
    google_ai_ultra:
      cost_per_month: 20
      limits: "Gemini 3 Pro 1M context"

# =============================================================================
# Auto-Delegation System Prompt
# =============================================================================
delegation:
  system_prompt: |
    ## AUTO-DELEGATION SYSTEM

    You can delegate tasks to specialized models:
    1. **Gemini 3 Pro** (1M context): `tri-agent-router --gemini "task"`
    2. **Codex GPT-5.2** (xhigh): `tri-agent-router --codex "task"`

    ### When to Delegate:
    - Files >50KB or >100K tokens → Gemini
    - "implement", "build", "fix" → Codex
    - Keep architecture/security decisions in Claude
    - Use consensus for critical decisions: `tri-agent-consensus "decision"`

    ### Delegation Format:
    When delegating, always include:
    1. Clear task description
    2. Relevant context/files
    3. Expected output format
    4. Success criteria
