# =============================================================================
# test.yaml - CI Test Workflow for tri-agent system
# =============================================================================
# Runs comprehensive test suites on PRs and pushes to main/develop branches.
# Includes unit, integration, property-based, fuzzing, and stress tests.
# =============================================================================

name: Tests

on:
  push:
    branches: [main, develop]
    paths:
      - 'bin/**'
      - 'lib/**'
      - 'tests/**'
      - 'config/**'
      - '.github/workflows/test.yaml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'bin/**'
      - 'lib/**'
      - 'tests/**'
      - 'config/**'
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Test type to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - unit
          - integration
          - fuzz
          - property
          - stress
          - advanced

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # Test configuration
  FUZZ_ITERATIONS: 50
  PROPERTY_ITERATIONS: 25
  PARALLEL_PROCESSES: 50
  STRESS_DURATION: 3
  # Disable color output for cleaner logs
  TERM: dumb

jobs:
  # ---------------------------------------------------------------------------
  # Unit Tests - Fast, isolated tests
  # ---------------------------------------------------------------------------
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq yq

      - name: Run unit tests
        run: |
          chmod +x tests/run_tests.sh tests/unit/*.sh
          ./tests/run_tests.sh unit

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-logs
          path: logs/
          retention-days: 7
          if-no-files-found: ignore

  # ---------------------------------------------------------------------------
  # Integration Tests - Tests that require external dependencies
  # ---------------------------------------------------------------------------
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: unit-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq yq curl

      - name: Run integration tests
        run: |
          chmod +x tests/run_tests.sh tests/integration/*.sh
          ./tests/run_tests.sh integration

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-logs
          path: logs/
          retention-days: 7
          if-no-files-found: ignore

  # ---------------------------------------------------------------------------
  # Property-Based Tests - Tests with randomized inputs
  # ---------------------------------------------------------------------------
  property-tests:
    name: Property-Based Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: unit-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq yq

      - name: Run property-based tests
        env:
          PROPERTY_ITERATIONS: ${{ env.PROPERTY_ITERATIONS }}
        run: |
          chmod +x tests/run_tests.sh tests/property/*.sh
          ./tests/run_tests.sh property

  # ---------------------------------------------------------------------------
  # Fuzz Tests - Tests with malformed/malicious inputs
  # ---------------------------------------------------------------------------
  fuzz-tests:
    name: Fuzzing Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: unit-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq yq

      - name: Run fuzzing tests
        env:
          FUZZ_ITERATIONS: ${{ env.FUZZ_ITERATIONS }}
        run: |
          chmod +x tests/run_tests.sh tests/fuzz/*.sh
          ./tests/run_tests.sh fuzz

  # ---------------------------------------------------------------------------
  # Stress Tests - Concurrency and load tests
  # ---------------------------------------------------------------------------
  stress-tests:
    name: Stress Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [unit-tests, integration-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq yq

      - name: Run stress tests
        env:
          PARALLEL_PROCESSES: ${{ env.PARALLEL_PROCESSES }}
          STRESS_DURATION: ${{ env.STRESS_DURATION }}
        run: |
          chmod +x tests/run_tests.sh tests/stress/*.sh
          ./tests/run_tests.sh stress

  # ---------------------------------------------------------------------------
  # Multi-Shell Compatibility
  # ---------------------------------------------------------------------------
  shell-compatibility:
    name: Shell Compatibility
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: unit-tests

    strategy:
      matrix:
        shell: [bash, dash, zsh]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install shell
        run: |
          sudo apt-get update
          sudo apt-get install -y ${{ matrix.shell }} jq yq

      - name: Test scripts syntax
        run: |
          # Test that scripts are valid bash (our target shell)
          for script in bin/* lib/*.sh; do
            if [[ -f "$script" ]]; then
              bash -n "$script" || echo "Syntax error in $script"
            fi
          done

  # ---------------------------------------------------------------------------
  # Multi-Platform Tests
  # ---------------------------------------------------------------------------
  multi-platform:
    name: Platform Tests
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    needs: unit-tests

    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Install dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew install jq yq

      - name: Run unit tests
        run: |
          chmod +x tests/run_tests.sh tests/unit/*.sh
          ./tests/run_tests.sh unit

  # ---------------------------------------------------------------------------
  # Test Summary
  # ---------------------------------------------------------------------------
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, property-tests, fuzz-tests, stress-tests]
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          results=("unit-tests:${{ needs.unit-tests.result }}"
                   "integration-tests:${{ needs.integration-tests.result }}"
                   "property-tests:${{ needs.property-tests.result }}"
                   "fuzz-tests:${{ needs.fuzz-tests.result }}"
                   "stress-tests:${{ needs.stress-tests.result }}")

          failures=0
          for result in "${results[@]}"; do
            name="${result%%:*}"
            status="${result##*:}"
            if [[ "$status" == "success" ]]; then
              echo "- $name: :white_check_mark: Passed" >> $GITHUB_STEP_SUMMARY
            elif [[ "$status" == "skipped" ]]; then
              echo "- $name: :fast_forward: Skipped" >> $GITHUB_STEP_SUMMARY
            else
              echo "- $name: :x: Failed" >> $GITHUB_STEP_SUMMARY
              ((failures++))
            fi
          done

          if [[ $failures -gt 0 ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo ":warning: **$failures test suite(s) failed**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo ":tada: **All tests passed!**" >> $GITHUB_STEP_SUMMARY
